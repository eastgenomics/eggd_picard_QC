# eggd Picard QC 
## What does this app do?
This app runs modules from the Picard Tools suite (picard.jar v2.22.2 bundled in resources/) to generate quality-control (QC) statistics from mapped/aligned reads. Specifically, this app (for capture panels):
* Calculates multiple summary statistic metrics for mapped reads (paired or unpaired) using Picard [CollectMultipleMetrics](https://broadinstitute.github.io/picard/command-line-overview.html#CollectMultipleMetrics).
* Calculates mappings metrics to determine the performance of the capture kit by assessing the coverage across all targets in the kit, using Picard [CollectHsMetrics](https://broadinstitute.github.io/picard/command-line-overview.html#CollectHsMetrics).

and for amplicon panels:
* Calculates mappings metrics to determine the performance of the amplicon kit by assessing the coverage across all targets in the kit, using Picard [TargetedPcrMetrics](https://broadinstitute.github.io/picard/command-line-overview.html#TargetedPcrMetrics).

and for RNA samples:
* Produces RNA alignment metrics for a SAM or BAM file using Picard [CollectRnaSeqMetrics](http://broadinstitute.github.io/picard/command-line-overview.html#CollectRnaSeqMetrics)

This app is also capable of producing variant-calling QC statistics for SNPs and indels using Picard [CollectVariantCallingMetrics](https://broadinstitute.github.io/picard/command-line-overview.html#CollectVariantCallingMetrics)

For more information on the Picard Tools suite see: http://broadinstitute.github.io/picard/

## What are typical use cases for this app?
This app is designed to be run on aligned sequencing data or variant calling data, either as a standalone app or as part of a DNAnexus workflow.  

The QC metrics calculated by Picard tools and output by this app are informative of the quality of NGS data; this includes the sequence alignments produced by read mapping software such as BWA and Bowtie2, or the variant calls produced by variant-calling software such as Sentieon.

The outputs of this app are to be displayed visually using [MultiQC](http://multiqc.info/), and assessed for inconsistencies across the alignment or variant-calling summaries. These summaries collectively contain the per-cycle base distribution, target enrichment, read duplication, and variant-calling statistics.

## What data are required for this app to run?
All inputs are optional from the perspective of DNANexus, which allows the app the flexibility of running QC on either alignments or variant calls. However, for successful exection, we list which data files are actually required for each mode to run. Bear in mind that some arguments are shared by alignment and variant calling (such as **fasta_index**), and as such care should be taken when running a complete assessment of the data.

### Alignment QC

The following files are required for alignment QC analysis to run:

**sorted_bam**:
A coordinate-sorted mapping file in BAM format (`*.bam`). BAM files generated by commonly used mappers such as BWA, BWA-MEM, Bowtie, TopHat, HISAT and NovoAlign are acceptable as input. 

**fasta_index**:
A reference genome sequence index generated by "FASTA indexer (with Picard and Samtools)". Make sure to use the same genome that was used to generate the BAM. This should be provided as a gzipped tar archive file (`*.fasta-index.tar.gz`).

**enrichment_method**
A boolean flag which denotes the run is a amplicon or capture based panel. 

Hybridisation = True will run [CollectMultipleMetrics](https://broadinstitute.github.io/picard/command-line-overview.html#CollectMultipleMetrics) and [CollectHsMetrics](https://broadinstitute.github.io/picard/command-line-overview.html#CollectHsMetrics). 

Hybridisation = False will run [TargetedPcrMetrics](https://broadinstitute.github.io/picard/command-line-overview.html#TargetedPcrMetrics).

The following files are optional for this app to run:

**bedfile**:
A BED file defining the enriched regions.

**refflat_file**:
A refflat file containing reference transcripts.

### Variant Calling QC

The following files are required for variant calling QC analysis to run:

**vcf**:
A VCF containing called SNP and indel variants

**vcf_index**:
Index file for compressed sample VCF (provided to `-ivcf`)

**fasta_index**:
A reference genome sequence index generated by "FASTA indexer (with Picard and Samtools)". Make sure to use the same genome that was used to generate the BAM. This should be provided as a gzipped tar archive file (`*.fasta-index.tar.gz`).

**dbsnp_vcf**
VCF reference file containing dbSNP variants
* _Warning: the dbSNP file must be generated using the same sequence dictionary expressed by the reference genome_

## What does this app output?
All Picard statistics files produced by this app are uploaded to a 'QC' directory in the DNAnexus project or working directory from which the app was called.

Picard CollectMultipleMetrics output files:
* `*.base_distribution_by_cycle*` - the base distribution per cycle
* `*.alignment_summary*` - a summary of the alignment
* `*.quality_by_cycle*` - the base quality per cycle
* `*.insert_size*` - metrics for validating library construction including the insert size distribution and read orientation of paired-end libraries
* `*.quality_distribution*` - the range of quality scores and the total numbers of bases corresponding to those scores

Picard CollectHsMetrics output files:
* `*.hsmetrics.tsv` - general statistics about the enrichment process. 
* `*.pertarget_coverage.tsv` - the GC content and average coverage of each target in the kit.

Picard TargetedPcrMetrics output files:
* `*.targetPCRmetrics.txt` - A summary of the performance of the target amplicons
* `*.perTargetCov.txt` - A per-amplicon summary of %GC and coverage.

Picard CollectRnaSeqMetrics output files:
* `*.RNAmetrics.tsv` - A summary of the metrics describing the distribution of the bases within the transcripts.

Picard CollectVariantCallingMetrics output files:
- `*.variant_calling_summary_metrics` - A summary of the metrics describing the quality of the called SNP and indel variants
- `*.variant_calling_detail_metrics` - Additional metrics relating to the quality of SNP and indel variant calls

Detailed information about the metrics reported by all Picard suites can be found at the following page:
https://broadinstitute.github.io/picard/picard-metric-definitions.html

## How does this app work?
This app downloads the given input files and uses BAM and BED files to create a picard intervals_list file. 
Depending on the capture/amplicon flag either Picard TargetedPcrMetrics or both Picard CollectMultipleMetrics and Picard CalculateHsMetrics are then called. 
If variant-calling is requested, the app downloads the VCF, reference genome and dbSNP file, and runs Picard CollectVariantCallingMetrics on the inputs.

All output files are uploaded into the directory 'QC'.
